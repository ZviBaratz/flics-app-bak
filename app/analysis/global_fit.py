import numpy as np
import symfit as sf
from symfit import Fit


def execute(self, **minimize_options):
    """
    Execute the fit.
    :param minimize_options: keyword arguments to be passed to the specified
        minimizer.
    :return: FitResults instance
    """
    minimizer_ans = self.minimizer.execute(**minimize_options)
#    minimizer_ans.covariance_matrix = self.covariance_matrix(
#        dict(zip(self.model.params, minimizer_ans._popt))
#    )
    # Overwrite the DummyModel with the current model
    minimizer_ans.model = self.model
    minimizer_ans.minimizer = self.minimizer
    return minimizer_ans

#monkeypatch
Fit.execute = execute


class GlobalFit(object):
    def __init__(self, data: dict, angle=0.0638281764032692,
                 pixel_to_micron_x=0.03651,
                 beam_waist_xy=0.2,
                 beam_waist_z=2e-6,
                 rbc_radius=6.2666,
                 tau_line=0.001,
            ):
        self.data = data
        self.angle = angle
        self.pixel_to_micron_x = pixel_to_micron_x
        self.beam_waist_xy = beam_waist_xy
        self.beam_waist_z = beam_waist_z
        self.rbc_radius = rbc_radius
        self.tau_line = tau_line
        self.s = 1  # 1 = one- photon . 2 = two-photon. in the article S = 1
        self.results = self.run()

    def create_distance_strings(self, prefix: str):
        return ', '.join(f'{prefix}_{distance}' for distance in self.data.keys())

    def run(self):
        print('global_fit starting')
        # create parameters for symfit
        distances = self.data.keys()
        v = sf.parameters('v_', value=545, min=500, max=600)[0]
        d = sf.parameters('D_', value=53, min=40, max=60)[0]

        y0_p = sf.parameters(
            self.create_distance_strings('y0'),
            min=0,
            max=1,
        )
        b_p = sf.parameters(
            self.create_distance_strings('b'),
            value=50,
            min=0,
            max=100,
        )
        # create variables for symfit
        x = sf.variables('x')[0]
        y_var = sf.variables(self.create_distance_strings('y'))

        sin_angle = sf.sin(self.angle)
        cos_angle = sf.cos(self.angle)
        denominator_part_calc = self.beam_waist_xy**2 + 0.5 * self.rbc_radius**2 * self.s
        xpixel_to_tualine = self.pixel_to_micron_x / self.tau_line

        # create model
        # pixel_to_micron_x
        model = sf.Model({
            y: y0 + b * sf.exp(-(dst * self.pixel_to_micron_x - v * cos_angle * x)**2 /
            (denominator_part_calc + 4 * self.s * d * x ) + (-(x*x) * (xpixel_to_tualine - v * sin_angle)**2 /
            (denominator_part_calc + 4 * self.s * d * x)))
            for y, y0, b, dst in zip(y_var, y0_p, b_p, distances)
        })
        # dependent variables dict
        data = {y.name: self.data[dst] for y, dst in zip(y_var, distances)}
        # independent variable x
        n_data_points = len(list(self.data.values())[0])
        max_time = n_data_points * self.tau_line
        x_data = np.linspace(0, max_time, n_data_points)
        # fit
        fit = Fit(model, x=x_data, **data)
        self.results = fit.execute()
        print('global_fit done')
        return self.results.params['v_']


"""
data_dict = {0: [4.473849148273866, 3.417058691921326, 3.224981237554649, 2.98710989859801, 2.734632393473725, 2.4846283262753173, 2.2488323811970146, 2.019703547280865, 1.8028012707590684, 1.5944280561616062, 1.4013500822897043, 1.2199909651104897, 1.051001476427318, 0.9055016687553401, 0.7903253762895815, 0.7061962067713575, 0.6511704287819492, 0.612886585423037, 0.5859073350955277, 0.5644475769319333, 0.5431987522980726, 0.530037355289158, 0.5248412782907618, 0.5318559470819558, 0.5474924373562311, 0.5695198637507062, 0.5980307606422444, 0.6310248352232346, 0.6634292475686252, 0.6970405044063633, 0.724277666976923, 0.7468108482735389, 0.7602466487985091, 0.76490103045614, 0.7658940815741704, 0.7590749555760131, 0.7443502470463251, 0.7243474359498804, 0.6896092540083377, 0.6565984688779006, 0.6124668355800836, 0.5687257207675033, 0.5274267998785815, 0.49159484303711837, 0.46237201422676444, 0.4392750471183202, 0.42276059982974407, 0.4119807916430433, 0.4049810665573533, 0.3991635808082973, 0.4002706219391093], 20: [3.3662631461852244, 3.4834095275897834, 3.4471641807183593, 3.2936178025173235, 3.0721927005694885, 2.8244866309692567, 2.5808520585850463, 2.346068033266311, 2.1156282768006958, 1.8956036398223408, 1.688703152923849, 1.494145189983232, 1.3015445787650008, 1.1268255560460725, 0.9762589567604106, 0.849233344503439, 0.7516013691738922, 0.6901098911542328, 0.6404808649696953, 0.6085905251593015, 0.5818933844448189, 0.5568977740052066, 0.540414070805999, 0.5331848234696615, 0.5322352467595827, 0.5473387767760974, 0.5705869141267869, 0.5979034131305522, 0.6308870514935461, 0.66230607407515, 0.6978008115626155, 0.7278412899994556, 0.7484101106300184, 0.7642746377068401, 0.7700704428696962, 0.7768857769305964, 0.7700018162101523, 0.7585749291778455, 0.7406006844232453, 0.7116552568926297, 0.6718283991547066, 0.6303156725347298, 0.5856491037965119, 0.5429222005634197, 0.5029956422133398, 0.47153494262783097, 0.4489631759181676, 0.42900002617817384, 0.4159287512372559, 0.40778595418052893, 0.4027441012587708], 40: [3.0605339822418376, 3.2891453676785614, 3.4383000788344735, 3.448197998184716, 3.3177976738886623, 3.123730736811546, 2.8877624500697867, 2.654055388144518, 2.4207337678783536, 2.1958913992315545, 1.9825042774086516, 1.775847522854419, 1.5721915658204229, 1.3835384607418506, 1.2044761033963463, 1.0441495394196447, 0.9067296392879688, 0.8024025482588636, 0.7275340594571715, 0.6739654724648938, 0.6327180606016882, 0.603223312843993, 0.5756696755842824, 0.5551759543547761, 0.5387201907396426, 0.5379755361482119, 0.5479061423999582, 0.5672640359087199, 0.5938002596813392, 0.625713350695657, 0.6592483483148693, 0.6941233753558065, 0.7259314110185578, 0.7530787909274453, 0.7711279094310729, 0.7815716001655029, 0.785171890022182, 0.78314596124029, 0.7723260343571119, 0.7546557599763037, 0.7274977023268615, 0.6885155171589407, 0.6473538523509283, 0.6001919498894749, 0.55722800979758, 0.5185427260119585, 0.4849454555154466, 0.45555563436956137, 0.4352846334966568, 0.4216883966520443, 0.40996070934518225], 60: [2.702479561570415, 2.955773301433959, 3.1966325161242946, 3.3696609505083557, 3.4142636364230103, 3.325448630470544, 3.1486030224918538, 2.928854728177533, 2.7022953485318957, 2.479828467107459, 2.260280510508835, 2.048193991083414, 1.8436782165146945, 1.6463402493238302, 1.456086556658729, 1.2746234123233273, 1.1097197804639893, 0.965908536833018, 0.8510881415848381, 0.7680744746827096, 0.7052884588829254, 0.6600333960560568, 0.6228333619392383, 0.5933746544975209, 0.5678661309346072, 0.5503648525668966, 0.5466757860827959, 0.5502705905820608, 0.5628100707860133, 0.5936204349932938, 0.6219151657676473, 0.655764587758706, 0.6914933318472692, 0.7277440166000835, 0.7563221663994799, 0.7759148574091017, 0.7893505667008157, 0.7944478864575117, 0.7963171786426806, 0.7853319296808993, 0.7697167972547598, 0.7439704046510753, 0.7096356986819699, 0.6703581987775503, 0.6198713394137209, 0.5738347611276519, 0.532764945260602, 0.49559111421920293, 0.46605886598044227, 0.442849033557708, 0.4269386440663126], 80: [2.3422227992937548, 2.5973946057787463, 2.8534008941286775, 3.0972927536194956, 3.2882570884812097, 3.364881925945502, 3.3077510826322647, 3.1544983631671233, 2.9511703850932895, 2.735474622141872, 2.5215282946517004, 2.3102753309746253, 2.107605305991857, 1.907461378115573, 1.7118043857344558, 1.5221296715688806, 1.3412064631410419, 1.1692504451933425, 1.024782152680838, 0.901344787725457, 0.8087260849677294, 0.7409034937125063, 0.6904788392561712, 0.648084249318975, 0.6099299360845184, 0.5861994385007249, 0.5643509527055454, 0.5548624756485095, 0.5571742784110253, 0.5687104977678815, 0.5925093100838079, 0.6201258218895254, 0.6563113029252304, 0.6934324568070275, 0.7259947416520125, 0.7601635525036897, 0.7809044809471224, 0.8003425157970357, 0.8070687992777911, 0.8089262529155734, 0.8032418474881432, 0.788633323042573, 0.7614688632472301, 0.7270490809129692, 0.6875420809007411, 0.6403695336841538, 0.5938395531447107, 0.5482467558797208, 0.5109712640756172, 0.4767446671863461, 0.45465145570192833], 100: [2.016269726950657, 2.2521394670728556, 2.499390623423556, 2.751615135189176, 2.9991659974422884, 3.1973312776696385, 3.302334145030498, 3.2735232632444906, 3.1538935920692808, 2.966237659743964, 2.759497921572597, 2.550053394550677, 2.3458292763610316, 2.1493874906348087, 1.957781689958387, 1.7655547451020388, 1.5764203373522785, 1.3969320260265423, 1.2281989129475113, 1.0734736664818654, 0.9475967760314941, 0.8466712435564712, 0.773845729136376, 0.7165218876509365, 0.6711332964270064, 0.6335361638328513, 0.5992347015716993, 0.5758965145462714, 0.5598349281634761, 0.5601331885807483, 0.5728085928249282, 0.591159284667012, 0.618347476911551, 0.655247158976769, 0.6896341090859959, 0.7274951950071666, 0.7618076093813425, 0.7888734983106869, 0.8064481262770461, 0.8185195330219531, 0.8242985354682784, 0.814389227390141, 0.803174097557299, 0.7829266283106379, 0.745412635346617, 0.706678966097413, 0.6612481994394042, 0.6142411778179866, 0.5673681042801928, 0.526503892980909, 0.4896298931730837], 120: [1.6955476096263613, 1.9252855951610828, 2.160280175894214, 2.4035347244851115, 2.6532899113319384, 2.8987606424964336, 3.107980473050526, 3.22748978208913, 3.2371821642226335, 3.135096222948367, 2.965477327292724, 2.7724709695315193, 2.5736778597982886, 2.374650701377446, 2.1864179681877496, 1.9942974042357051, 1.807995210686511, 1.6243644651639202, 1.4485035186453525, 1.2718322569758131, 1.121072665564279, 0.985528680097939, 0.8823692648888227, 0.8014791474019147, 0.7424551205873829, 0.694104618219049, 0.651427575615808, 0.6135398691740311, 0.5846528765841313, 0.5682935538961021, 0.5640153077113522, 0.5725608537171121, 0.5915805928492359, 0.6194241773336344, 0.6532637857884854, 0.6917988724859886, 0.7262866587513157, 0.7638893266105965, 0.7964909874912042, 0.817321108539213, 0.8317605122445021, 0.8374962337675982, 0.8376944021615815, 0.8233183177291471, 0.8022281048758592, 0.7686955527968116, 0.7300775304515109, 0.6857310549426356, 0.6329679585848427, 0.5866332481100426, 0.5429452508229347], 140: [1.4023001229567458, 1.6101570970150487, 1.8339538968554476, 2.069377591506621, 2.305196372334589, 2.551178933554907, 2.7993571347740236, 3.015001138505864, 3.1556379378002504, 3.1859442196352745, 3.113521108896641, 2.962983901729157, 2.7825954501877534, 2.58881972708981, 2.3967896066774093, 2.2050636359439526, 2.0241490540486504, 1.844091075163309, 1.6659875924082925, 1.4916694017046137, 1.3209057841853478, 1.1630182123310389, 1.024261517714798, 0.9126986511141907, 0.8284696239390303, 0.7653719665241152, 0.714322175148087, 0.6694996414022388, 0.63017785702955, 0.5991865992560313, 0.5789467038394011, 0.5695494740593878, 0.5728321493487226, 0.5877096036028283, 0.6155246642371096, 0.6468313621946808, 0.6869865673705745, 0.7289099535996508, 0.7637947241957859, 0.8005533749675717, 0.8261409658922648, 0.8449616705028153, 0.8536305541385605, 0.8528611261903525, 0.8433847773823223, 0.8258523638372363, 0.7935615966365213, 0.7542189625053896, 0.7079364849825419, 0.6564703543924546, 0.612139406075502], 160: [1.1265295785814025, 1.316669988989853, 1.525570255074365, 1.7440827820228249, 1.9777076509320919, 2.2132309895777653, 2.4557986360253143, 2.6941085893406194, 2.91638445457553, 3.070279420824088, 3.1296674213628908, 3.0751934020549245, 2.948976925414041, 2.783987589537818, 2.5973399262766734, 2.4127278235582135, 2.228488380595816, 2.052502365027662, 1.8722996211516314, 1.6934276029373334, 1.5254805082542777, 1.3585253231160137, 1.198947919165487, 1.0584033736225922, 0.9415226757074752, 0.8546855929178085, 0.7854971517818864, 0.7312763161639652, 0.6847914200326928, 0.6391523897048565, 0.6077400643048909, 0.5831105842520572, 0.5695577386719533, 0.5699949418402056, 0.5860540542753324, 0.6072891431049174, 0.6414664858326848, 0.67934402284064, 0.7217349621563797, 0.7628025937860644, 0.7997252530263793, 0.8296902579057394, 0.8488819644798611, 0.8632802953319078, 0.8687440694604686, 0.862056838664842, 0.84359995398586, 0.8187093903713739, 0.7808850075758524, 0.7340071901314063, 0.683180545094018], 180: [0.8755629658815682, 1.049380661203861, 1.2397837696791039, 1.4439376632459826, 1.6520384745902303, 1.8841560537038318, 2.117298649938192, 2.357193442570285, 2.593864239450699, 2.815308312064513, 2.984340019509034, 3.065498215449969, 3.0355592911413463, 2.9312149426153185, 2.7791076976399247, 2.601339615916835, 2.4294721233057888, 2.243271271355424, 2.06992509353382, 1.8996503172444628, 1.721183915850036, 1.554406827208341, 1.3900662614675194, 1.2284209514432198, 1.0862624725905599, 0.9662028244588848, 0.8750654160532091, 0.8038726186997142, 0.7466939558940839, 0.6960942797019829, 0.6531574922454625, 0.6149067384505132, 0.5865377300699076, 0.5708481250211419, 0.5712411684996559, 0.5810734222911298, 0.6024555533022876, 0.6334783878781872, 0.6738472429266705, 0.7141055400978977, 0.7571437624467363, 0.7947831334584385, 0.8317712921563879, 0.8546536906796188, 0.8721948124527326, 0.8760002554952975, 0.8769106883624022, 0.8621639681607394, 0.839492186141544, 0.8051469207531824, 0.7637743801997303], 200: [0.6586491480872838, 0.8052628220537963, 0.9753194588179743, 1.1593917138696594, 1.3508346246347447, 1.5640021310039314, 1.7881868089353317, 2.019370004674152, 2.258041915885125, 2.494827924810698, 2.7164928052099127, 2.89092035623289, 2.99117076287337, 2.9873099367414317, 2.9033198920126715, 2.7690108840656777, 2.6025018835615374, 2.43250736686758, 2.2606267985006845, 2.091185837154448, 1.9216386935958423, 1.7548018784485067, 1.5810164066716812, 1.4159379300322255, 1.2566259159400701, 1.112272162288702, 0.9919996784119547, 0.8985341697636589, 0.8210914344991621, 0.7644209779688352, 0.7112109044678829, 0.6659353912678517, 0.6263793952178963, 0.5942669149391697, 0.5753076136095153, 0.5708531222127875, 0.5794014235096968, 0.5968708111444246, 0.6261640999331923, 0.6620357455695578, 0.7038118207062601, 0.7507993049917648, 0.7903464341963694, 0.8303212208700427, 0.8581859267368562, 0.8778329329124547, 0.890343687889971, 0.891256109904964, 0.8843211110308697, 0.8591703281353203, 0.8291100213068797], 220: [0.5113307796976129, 0.6062357507675026, 0.7451384703720493, 0.9029772053675421, 1.0815434039849123, 1.2732542863103133, 1.4782662171648595, 1.6972078943220037, 1.9248114088389816, 2.1621169368955946, 2.3935997533447724, 2.6121889109336984, 2.7999402684440247, 2.9149016495124918, 2.938482042011541, 2.8638058739338064, 2.748871206414375, 2.597076044490644, 2.4369450697211565, 2.273863268786042, 2.107460012638491, 1.9410704078408616, 1.7764708392059894, 1.6062855864562913, 1.4404222626637484, 1.279755424218237, 1.1365540216376686, 1.010508959498671, 0.912717497531093, 0.8353325440206737, 0.7737801115835939, 0.7217539318965537, 0.6748770789101294, 0.6332912439671909, 0.5994528521456226, 0.5768828620996898, 0.5694443021252422, 0.5707356579889811, 0.5900774548555326, 0.6139666982259309, 0.6536286624773565, 0.6936333145646388, 0.743372902421055, 0.7832083277085262, 0.828832241335399, 0.8593396623255584, 0.880892466480474, 0.8992793700965208, 0.902983644122269, 0.8965065586723094, 0.8832518542604151], 240: [0.43479678427829005, 0.47737214590964844, 0.5613266070824128, 0.6833574701717181, 0.8354254515476938, 1.003965884592291, 1.1898343018777033, 1.3981571590780013, 1.6036970147898606, 1.8304683404069957, 2.06211442326144, 2.286227666903191, 2.51218160034931, 2.699455118286706, 2.827616241959246, 2.8691779882483166, 2.8239326255201593, 2.7190659587830557, 2.5845966617263945, 2.4334692503815427, 2.2738958856402762, 2.1190194027164275, 1.957750465102131, 1.7965796647039851, 1.6312522499903077, 1.4702509739493528, 1.3058908729789087, 1.1562813272722452, 1.0258832420128252, 0.9215683537034418, 0.8452276811054413, 0.784251735838962, 0.7317765588705085, 0.6833144720616856, 0.6405987205845209, 0.6065279188153252, 0.5783850440098609, 0.5668915115103502, 0.5652105827091483, 0.5792590199074764, 0.6048030197671076, 0.638504308573703, 0.6831813020496743, 0.7267434170807615, 0.7777936027360332, 0.8164249752962373, 0.8539491076285538, 0.8832127639765928, 0.9003346590768055, 0.9089752623911898, 0.9070171049467973], 260: [0.42406023984324, 0.4231335206231841, 0.4532730534009743, 0.5190050074812858, 0.6313429943077958, 0.7752455591329902, 0.9406680738705351, 1.1152566258614183, 1.3117624141240252, 1.5197334396664657, 1.7374542983703298, 1.9638208519905287, 2.1896041270249285, 2.414399984533325, 2.6001039799696564, 2.7430731501051655, 2.8010457740355705, 2.7827199545365104, 2.690353351168605, 2.5589015825687644, 2.4240526514243, 2.2760609525285953, 2.1228816529703964, 1.9708130608026886, 1.8122576789539306, 1.6506058528314598, 1.4872638291697489, 1.3264409522512794, 1.1767079862023273, 1.0402779454149285, 0.9302837123274257, 0.849242252905983, 0.7856172513734337, 0.733236582962695, 0.6856380728358045, 0.6435577147372414, 0.6053033309403182, 0.5805967439214944, 0.5639847945441064, 0.5615789225597694, 0.5720160316296768, 0.5954640782001733, 0.6244865570341885, 0.6686140607276383, 0.7134362659345487, 0.7619015124215059, 0.8044457846623307, 0.8457034438087293, 0.8737014249708286, 0.9015400450479836, 0.9114649232036539], 280: [0.4425094693895074, 0.4233576176993794, 0.4176753052686549, 0.43541379263792224, 0.4895977192857881, 0.5834509799549024, 0.7160296371827358, 0.8775353177647702, 1.0484819143885904, 1.2369026951989088, 1.4349397224802491, 1.6501553034861856, 1.8722153662407195, 2.096867972807736, 2.3053467805197663, 2.504352934291489, 2.651742414380663, 2.7253431635039806, 2.7186163801213197, 2.644006581422696, 2.534689136449823, 2.408745611650504, 2.267913303146959, 2.120464057910753, 1.9737699135853704, 1.820025805719865, 1.65915784635866, 1.5046806649278912, 1.3393253146996213, 1.1903396536724844, 1.052178083738967, 0.9378392328605943, 0.8522643614415301, 0.7862862478422366, 0.7323245175768982, 0.6834074030185125, 0.6405392335726033, 0.6028644957936506, 0.5739687582281626, 0.558396030621948, 0.5536802443518657, 0.5616781882244637, 0.5833206137371094, 0.610584088745348, 0.6499774291915064, 0.6959190594407773, 0.7461158069697044, 0.7940490886598495, 0.8358186930585976, 0.8688434275165617, 0.8939426246729535]}
global_fit = GlobalFit(data_dict)
v = global_fit.results
print(f'v={v}')
"""
